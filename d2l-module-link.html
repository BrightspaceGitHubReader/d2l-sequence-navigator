<link rel="import" href="bower_components/polymer/polymer-element.html">
<link rel="import" href="bower_components/d2l-fetch-siren-entity-behavior/d2l-fetch-siren-entity-behavior.html">
<link rel="import" href="bower_components/d2l-accordion/d2l-accordion.html">
<link rel="import" href="d2l-activity-link.html">

<dom-module id="d2l-module-link">
	<template>
		<style>
			:host {
				display: block;
			}
		</style>
		<slot></slot>
		<d2l-accordion-collapse on-click="toggleSelected" title="[[entity.properties.title]]" id="moduleAccordion" no-icons auto-close>
			<div style="border: 1px solid red; padding:5px">
				<d2l-accordion>
					<template is="dom-repeat" items="[[entity.entities]]">
						<template is="dom-if" if="[[isModule(item)]]">
							<d2l-module-link
								entity="[[item]]"
								current-activity="{{currentActivity}}"
								selected-module="{{selectedModule}}"
							>
							</d2l-module-link>
						</template>
						<template is="dom-if" if="[[isActivity(item)]]">
							<d2l-activity-link
								entity="[[item]]"
								current-activity="{{currentActivity}}"
							>
							</d2l-activity-link>
						</template>
					</template>
				</d2l-accordion>
			</div>
		</d2l-accordion-collapse>

	</template>
	<script>
		class D2LModuleLink extends Polymer.mixinBehaviors([D2L.PolymerBehaviors.FetchSirenEntityBehavior], Polymer.Element) {
			static get is() {
				return 'd2l-module-link';
			}
			static get properties() {
				return {
					entity: {
						type: Object
					},
					currentActivity: {
						type: String,
						value: '',
						notify: true
					},
					selectedModule: {
						type: String,
						value: '',
						observer: 'onSelectedModuleChanged',
						notify: true
					}
				};
			}
			isModule( entity ) {
				return entity.class[1] === 'sequence-description';
			}
			isActivity( entity ) {
				return entity.class[0] === 'sequenced-activity' && Object.keys(entity.properties).length > 0;
			}
			countCompletedActivities(entity) {
				if (!entity.entities) return 0;
				var total = 0;
				for (var i = 0; i < entity.entities.length; i++) {
					var child = entity.entities[i];
					if (this.isActivity(child)) {
						if (this.isComplete(child)) {
							total++;
						}
					}
					else if (this.isModule(child)) {
						total += this.countCompletedActivities(child);
					}
				}
				return total;
			}
			isComplete(activity) {
				return activity
					.getSubEntityByRel('about')
					.getSubEntityByClass('completion')
					.hasClass('completed');
			}
			countActivities(entity) {
				var total = 0;
				for (var i = 0; i < entity.entities.length; i++) {
					var child = entity.entities[i];
					if (this.isActivity(child)) {
						total ++;
					}
					else if (this.isModule(child)) {
						total += this.countActivities(child);
					}
				}
				return total;
			}
			toggleSelected() {
				if ( this.$.moduleAccordion.classList.contains('selected') ) {
					this.selectedModule = '';
				}
				else {
					this.selectedModule = this.entity.getLinkByRel('self').href;
				}
				//this.$.moduleAccordion.opened = !this.$.moduleAccordion.opened;
			}
			onSelectedModuleChanged() {
				var selected = this.entity && this.entity.getLinkByRel('self').href === this.selectedModule;
				if ( selected ) {
					this.$.moduleAccordion.classList.add('selected');
				}
				else {
					this.$.moduleAccordion.classList.remove('selected');
				}
			}
			isSelected( entity ) {
				var selected = entity.getLinkByRel('self').href === this.selectedModule;
				return selected;
			}

			constructor() {
				super();
			}
			ready() {
				super.ready();
			}
		}
		customElements.define(D2LModuleLink.is, D2LModuleLink);
	</script>
</dom-module>
