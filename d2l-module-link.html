<link rel="import" href="bower_components/polymer/polymer-element.html">
<link rel="import" href="bower_components/d2l-fetch-siren-entity-behavior/d2l-fetch-siren-entity-behavior.html">
<link rel="import" href="d2l-activity-link.html">

<dom-module id="d2l-module-link">
	<template>
		<style>
			:host {
				display: block;
			}
			.selected {
				color: blue;
			}
		</style>
		<slot></slot>
		<a id="moduleLink" on-click="toggleSelected">[[entity.properties.title]]</a>
		<ul>
		<template is="dom-repeat" items="[[entity.entities]]">

			<template is="dom-if" if="[[showChildModule(item)]]">
				<li>
					<d2l-module-link
						entity="[[item]]"
						current-activity="{{currentActivity}}"
						selected-module="{{selectedModule}}"
					>
					</d2l-module-link>
				</li>
			</template>
			<template is="dom-if" if="[[showChildActivity(item)]]">
				<li>
					<d2l-activity-link
						entity="[[item]]"
						current-activity="{{currentActivity}}"
					>
					</d2l-activity-link>
				</li>
			</template>
		</li>
		</template>
		</ul>

	</template>
	<script>
		class D2LModuleLink extends Polymer.mixinBehaviors([D2L.PolymerBehaviors.FetchSirenEntityBehavior], Polymer.Element) {
			static get is() {
				return 'd2l-module-link';
			}
			static get properties() {
				return {
					entity: {
						type: Object
					},
					currentActivity: {
						type: String,
						value: "",
						notify: true
					},
					selectedModule: {
						type: String,
						value: "",
						observer: "onSelectedModuleChanged",
						notify: true
					}
				}
			}
			showChildModule(childEntity){
				return childEntity.class[1] === 'sequence-description';
			}
			showChildActivity(childEntity) {
				return childEntity.class[0] === 'sequenced-activity' && Object.keys(childEntity.properties).length > 0;
			}
			toggleSelected() {
				if(this.isSelected()) {
					this.selectedModule = "";
				}
				else {
					this.selectedModule = this.entity.getLinkByRel("self").href;
				}
			}
			onSelectedModuleChanged() {
				if(this.isSelected()) {
					this.$.moduleLink.classList.add("selected");
				}
				else {
					this.$.moduleLink.classList.remove("selected");
				}
			}
			isSelected() {
				return this.entity && this.entity.getLinkByRel("self").href == this.selectedModule;
			}

			constructor() {
				super();
			}
			ready(){
				super.ready();
			}
		}
		customElements.define(D2LModuleLink.is, D2LModuleLink);
	</script>
</dom-module>
