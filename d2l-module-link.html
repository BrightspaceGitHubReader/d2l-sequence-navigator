<link rel="import" href="bower_components/polymer/polymer-element.html">
<link rel="import" href="bower_components/d2l-fetch-siren-entity-behavior/d2l-fetch-siren-entity-behavior.html">
<link rel="import" href="d2l-activity-link.html">

<dom-module id="d2l-module-link">
	<template>
		<style>
			:host {
				display: block;
			}
			.selected {
				color: blue;
			}
			li {
				list-style-type: none;
			}
		</style>
		<a id="moduleLink" on-click="toggleSelected">[[entity.properties.title]]
			([[completionCount.completed]] of [[completionCount.total]])
		</a>
		<ol>
			<template is="dom-repeat" items="[[entity.entities]]">
				<template is="dom-if" if="[[isModule(item)]]">
					<li>
						<d2l-module-link
							entity="[[item]]"
							current-activity="{{currentActivity}}"
							selected-module="{{selectedModule}}"
						></d2l-module-link>
					</li>
				</template>
				<template is="dom-if" if="[[isActivity(item)]]">
					<li>
						<d2l-activity-link
							entity="[[item]]"
							current-activity="{{currentActivity}}"
						></d2l-activity-link>
					</li>
				</template>
			</template>
		</ol>
	</template>
	<script>
		class D2LModuleLink extends Polymer.mixinBehaviors([D2L.PolymerBehaviors.FetchSirenEntityBehavior], Polymer.Element) {
			static get is() {
				return 'd2l-module-link';
			}
			static get properties() {
				return {
					entity: {
						type: Object
					},
					currentActivity: {
						type: String,
						value: '',
						notify: true
					},
					selectedModule: {
						type: String,
						value: '',
						observer: 'onSelectedModuleChanged',
						notify: true
					},
					completionCount:{
						type: Object,
						value: {
							completed: 0,
							total: 0
						},
						computed: 'countCompletedActivities(entity)'
					}
				};
			}
			isModule( entity ) {
				return entity.class[1] === 'sequence-description';
			}
			isActivity( entity ) {
				return entity.class[0] === 'sequenced-activity' && Object.keys(entity.properties).length > 0;
			}
			countCompletedActivities(entity) {
				const result = {
					completed: 0,
					total: 0
				};
				if (!entity.entities) return result;
				for (var i = 0; i < entity.entities.length; i++) {
					var child = entity.entities[i];
					if (this.isActivity(child)) {
						result.total++;
						if (this.isComplete(child)) {
							result.completed++;
						}
					}
					else if (this.isModule(child)) {
						var childCount = this.countCompletedActivities(child);
						result.completed += childCount.completed;
						result.total += childCount.total;
					}
				}
				return result;
			}
			isComplete(activity) {
				return activity
					.getSubEntityByRel('about')
					.getSubEntityByClass('completion')
					.hasClass('completed');
			}
			toggleSelected() {
				if ( this.$.moduleLink.classList.contains('selected') ) {
					this.selectedModule = '';
				}
				else {
					this.selectedModule = this.entity.getLinkByRel('self').href;
				}
			}
			onSelectedModuleChanged() {
				var selected = this.entity && this.entity.getLinkByRel('self').href === this.selectedModule;
				if ( selected ) {
					this.$.moduleLink.classList.add('selected');
				}
				else {
					this.$.moduleLink.classList.remove('selected');
				}
			}

			constructor() {
				super();
			}
			ready() {
				super.ready();
			}
		}
		customElements.define(D2LModuleLink.is, D2LModuleLink);
	</script>
</dom-module>
