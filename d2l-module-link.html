<link rel="import" href="bower_components/polymer/polymer-element.html">
<link rel="import" href="bower_components/polymer-siren-mixins/siren-entity-mixin.html">
<link rel="import" href="d2l-activity-link.html">

<dom-module id="d2l-module-link">
	<template>
		<style>
			:host {
				display: block;
			}
			.selected {
				color: blue;
			}
			li {
				list-style-type: none;
			}
		</style>
		<a id="moduleLink" on-click="toggleSelected">[[entity.properties.title]]
			([[completionCount.completed]] of [[completionCount.total]])
		</a>
		<ol>
			<template is="dom-repeat" items="[[entity.entities]]" as="childEntity">
				<template is="dom-if" if="[[isModule(childEntity)]]">
					<li>
						<d2l-module-link
							href="[[getHref(childEntity)]]"
							token="[[token]]"
							current-activity="{{currentActivity}}"
							selected-module="{{selectedModule}}"
						></d2l-module-link>
					</li>
				</template>
				<template is="dom-if" if="[[isActivity(childEntity)]]">
					<li>
						<d2l-activity-link
							href="[[getHref(childEntity)]]"
							token="[[token]]"
							current-activity="{{currentActivity}}"
						></d2l-activity-link>
					</li>
				</template>
			</template>
		</ol>
	</template>
	<script>
		/*
		@mixes SirenEntityMixin
		*/
		class D2LModuleLink extends D2L.Polymer.Mixins.SirenEntityMixin( Polymer.Element ) {
			static get is() {
				return 'd2l-module-link';
			}
			static get properties() {
				return {
					currentActivity: {
						type: String,
						value: '',
						notify: true
					},
					selectedModule: {
						type: String,
						value: '',
						observer: 'onSelectedModuleChanged',
						notify: true
					},
					completionCount:{
						type: Object,
						value: {
							completed: 0,
							total: 0
						},
						computed: 'countCompletedActivities(entity)'
					}
				};
			}

			constructor() {
				super();
			}

			ready() {
				super.ready();
			}

			getHref(childEntity) {
				return childEntity.getLinkByRel('self').href;
			}

			isModule(childEntity) {
				return childEntity.class[1] === 'sequence-description';
			}

			isActivity(childEntity) {
				return childEntity.class[0] === 'sequenced-activity' && Object.keys(childEntity.properties).length > 0;
			}

			countCompletedActivities(entity) {
				const result = {
					completed: 0,
					total: 0
				};
				if ( !entity.entities ) {
					return result;
				}
				for ( var i = 0; i < entity.entities.length; i++ ) {
					var child = entity.entities[i];
					if ( this.isActivity(child) ) {
						result.total++;
						if ( this.isComplete(child) ) {
							result.completed++;
						}
					} else if ( this.isModule(child) ) {
						var childCount = this.countCompletedActivities(child);
						result.completed += childCount.completed;
						result.total += childCount.total;
					}
				}
				return result;
			}

			isComplete(activity) {
				return activity
					.getSubEntityByRel('about')
					.getSubEntityByClass('completion')
					.hasClass('completed');
			}

			toggleSelected() {
				if ( this.$.moduleLink.classList.contains('selected') ) {
					this.selectedModule = '';
				} else {
					this.selectedModule = this._getLinkByRel( this.entity, 'self').href;
				}
			}

			onSelectedModuleChanged() {
				var selected = this.entity && this._getLinkByRel( this.entity, 'self').href === this.selectedModule;
				if ( selected ) {
					this.$.moduleLink.classList.add('selected');
				} else {
					this.$.moduleLink.classList.remove('selected');
				}
			}
		}
		customElements.define(D2LModuleLink.is, D2LModuleLink);
	</script>
</dom-module>
